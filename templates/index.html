<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Grid Map Visualization</title>
        <style>
            /* General Page Styling */
            body {
                font-family: "Arial", sans-serif;
                text-align: center;
                background-color: #f5f5f5;
                color: #333;
            }

            h1 {
                color: #2c3e50;
            }

            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
            }

            .grid {
                display: grid;
                gap: 2px;
                margin: 20px;
                border: 2px solid #2c3e50;
                background-color: #fff;
                padding: 10px;
                border-radius: 5px;
            }

            .cell {
                width: 50px;
                height: 50px;
                background-color: white;
                border: 1px solid black;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                position: relative;
            }

            /* Colors for Different Grid Types */
            .start {
                background-color: #27ae60;
                color: white;
            }
            .goal {
                background-color: #e74c3c;
                color: white;
            }
            .obstacle {
                background-color: gray;
            }
            .current {
                background-color: yellow;
            }

            /* Buttons */
            button {
                background-color: #3498db;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                margin: 10px;
                transition: 0.3s;
            }

            button:hover {
                background-color: #2980b9;
            }

            /* Hidden Sections for Results */
            .results {
                display: none; /* Initially Hidden */
                margin-top: 30px;
            }

            .grid-container {
                display: flex;
                justify-content: space-around;
                width: 100%;
                flex-wrap: wrap;
            }

            .grid-box {
                text-align: center;
                padding: 15px;
                background: #ecf0f1;
                border-radius: 10px;
                box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <h1>Grid Map Visualization</h1>
        <label for="size">Choose Grid Size (5-9):</label>
        <input type="number" id="size" min="5" max="9" value="5" />
        <button onclick="generateGrid()">Generate Grid</button>

        <div class="container">
            <div id="gridContainer" class="grid"></div>
            <button onclick="evaluateValues()">Compute Value Evaluation</button>
        </div>

        <!-- Hidden by Default: Display After Computing -->
        <div id="resultsSection" class="results">
            <div class="grid-container">
                <div class="grid-box">
                    <h2>Path Animation</h2>
                    <div id="pathGrid" class="grid"></div>
                </div>
                <div class="grid-box">
                    <h2>Policy Arrows</h2>
                    <div id="policyGrid" class="grid"></div>
                </div>
                <div class="grid-box">
                    <h2>Value (V)</h2>
                    <div id="valueGrid" class="grid"></div>
                </div>
            </div>
        </div>

        <script>
            let gridSize = 5;
            let gridData = [];
            let obstacleCount = 0;
            let maxObstacles = 3;

            function generateGrid() {
                gridSize = parseInt(document.getElementById("size").value);
                maxObstacles = gridSize - 2;
                obstacleCount = 0;
                gridData = Array.from({ length: gridSize }, () =>
                    Array(gridSize).fill("empty")
                );

                const gridContainer = document.getElementById("gridContainer");
                gridContainer.innerHTML = "";
                gridContainer.style.gridTemplateColumns = `repeat(${gridSize}, 50px)`;
                gridContainer.style.gridTemplateRows = `repeat(${gridSize}, 50px)`;

                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        let cell = document.createElement("div");
                        cell.classList.add("cell");
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.onclick = () => cellClicked(i, j, cell);
                        gridContainer.appendChild(cell);
                    }
                }

                // Hide the results section when regenerating
                document.getElementById("resultsSection").style.display =
                    "none";
            }

            function cellClicked(row, col, cell) {
                if (gridData[row][col] === "empty") {
                    if (!gridData.flat().includes("start")) {
                        cell.classList.add("start");
                        gridData[row][col] = "start";
                    } else if (!gridData.flat().includes("goal")) {
                        cell.classList.add("goal");
                        gridData[row][col] = "goal";
                    } else if (obstacleCount < maxObstacles) {
                        cell.classList.add("obstacle");
                        gridData[row][col] = "obstacle";
                        obstacleCount++;
                    }
                }
            }

            function evaluateValues() {
                fetch("/evaluate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ grid: gridData, size: gridSize }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        drawGrid("policyGrid", data.policy);
                        drawGrid("valueGrid", data.values, true);
                        animatePath(data.path);

                        // Show the results section
                        document.getElementById(
                            "resultsSection"
                        ).style.display = "block";
                    });
            }

            function drawGrid(gridId, data, isValue = false) {
                const gridContainer = document.getElementById(gridId);
                gridContainer.innerHTML = "";
                gridContainer.style.gridTemplateColumns = `repeat(${gridSize}, 50px)`;

                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        let cell = document.createElement("div");
                        cell.classList.add("cell");
                        if (gridData[i][j] === "start")
                            cell.classList.add("start");
                        if (gridData[i][j] === "goal")
                            cell.classList.add("goal");
                        if (gridData[i][j] === "obstacle")
                            cell.classList.add("obstacle");

                        if (gridData[i][j] === "empty") {
                            let text = document.createElement("div");
                            text.innerText = isValue
                                ? data[i][j].toFixed(2)
                                : getArrowSymbol(data[i][j]);
                            cell.appendChild(text);
                        }
                        gridContainer.appendChild(cell);
                    }
                }
            }

            function animatePath(path) {
                let step = 0;
                const pathGrid = document.getElementById("pathGrid");
                pathGrid.innerHTML = "";
                pathGrid.style.gridTemplateColumns = `repeat(${gridSize}, 50px)`;

                let interval = setInterval(() => {
                    if (step >= path.length) {
                        clearInterval(interval);
                        return;
                    }
                    drawGrid("pathGrid", gridData);
                    let [row, col] = path[step];
                    let cell = document.querySelector(
                        `#pathGrid .cell:nth-child(${row * gridSize + col + 1})`
                    );
                    cell.classList.add("current");
                    step++;
                }, 500);
            }

            function getArrowSymbol(action) {
                return (
                    { up: "↑", down: "↓", left: "←", right: "→" }[action] || ""
                );
            }
        </script>
    </body>
</html>
